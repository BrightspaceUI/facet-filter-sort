<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="d2l-search-facets">
	<template strip-whitespace>
		<style>
			:host {
				display: block;
			}
		</style>
		<slot></slot>
	</template>
	<script>
		/**
		 * `<d2l-search-facets>`
		 * Polymer-based web component for D2L search facets.
		 */
		class SearchFacets extends Polymer.Element {
			static get is() { return 'd2l-search-facets'; }
			static get properties() {
				return {
					/**
					* Reference to bound listener functions to be removed in disconnectedCallback
					*/
					_boundListeners: {
						type: Object,
						value: function() {
							return {
								_onFacetGroupingChange: null,
							};
						}
					},
					/**
					* An object that contains all selected options under the respective groupings.
					* (e.g., { groupingA: ['optionA', ...] , groupingB: [...] })
					*/
					optionsSelected: {
						type: Object,
						value: function() { return {}; },
					}
				};
			}

			connectedCallback() {
				super.connectedCallback();

				Polymer.RenderStatus.afterNextRender(this, function() {
					this._boundListeners._onFacetGroupingChange = this._onFacetGroupingChange.bind(this);
					this.addEventListener('d2l-search-facets-grouping-change',
						this._boundListeners._onFacetGroupingChange);
					// Query for the initial groupings and initialize the selected options
					const groupings = Polymer.FlattenedNodesObserver.getFlattenedNodes(this)
						.filter(function(n) { return n.nodeType === Node.ELEMENT_NODE; });

					groupings.forEach(function(grouping) {
						if (grouping.value) {
							this.optionsSelected[grouping.value] = [];
						}
					}.bind(this));
				}.bind(this));
			}

			disconnectedCallback() {
				super.disconnectedCallback();
				this.removeEventListener('d2l-search-facets-grouping-change',
					this._boundListeners._onFacetGroupingChange);
			}

			_onFacetGroupingChange(e) {
				this.optionsSelected[e.detail.grouping] = e.detail.selected;
				this.dispatchEvent(new CustomEvent(
					'd2l-search-facets-change',
					{ bubbles: true, composed: true, detail: this.optionsSelected }
				));
			}
		}

		customElements.define(SearchFacets.is, SearchFacets);
	</script>
</dom-module>
