<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../d2l-inputs/d2l-input-checkbox-spacer.html">
<link rel="import" href="../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">

<dom-module id="d2l-search-facets-grouping">
	<template strip-whitespace>
		<style>
			:host {
				display: block;
			}

			.d2l-search-facets-grouping-fieldset {
				border: none;
				margin: 0;
				padding: 0;
			}

			.d2l-search-facets-grouping-legend {
				@apply --d2l-body-compact-text;
				font-weight: bold;
				margin-bottom: 0.4rem;
				padding: 0;
			}

			.d2l-search-facets-grouping-show-more > button {
				@apply --d2l-body-compact-text;
				border: none;
				color: var(--d2l-color-celestine);
				font-family: inherit;
				outline: none;
				padding: 0;
			}

			.d2l-search-facets-grouping-show-more > button:hover,
			.d2l-search-facets-grouping-show-more > button:focus {
				cursor: pointer;
				font-weight: bold;
			}

		</style>
		<fieldset class="d2l-search-facets-grouping-fieldset">
			<legend class="d2l-search-facets-grouping-legend">[[text]]</legend>
			<slot></slot>
			<template is="dom-if" if="[[_showOptionsButtonVisible]]">
				<d2l-input-checkbox-spacer class="d2l-search-facets-grouping-show-more">
					<button on-click="_showOptions">More</button>
				</d2l-input-checkbox-spacer>
			</template>
		</fieldset>
	</template>
	<script>
		/**
		 * `<d2l-search-facets-grouping>`
		 * A grouping of search facet options that keeps tracks of selected options
		 */
		class SearchFacetsGrouping extends Polymer.Element {
			static get is() { return 'd2l-search-facets-grouping'; }
			static get properties() {
				return {
					/**
					* Reference to bound listener functions to be removed in disconnectedCallback
					*/
					_boundListeners: {
						type: Object,
						value: function() {
							return {
								_onFacetOptionChange: null,
							};
						}
					},
					/**
					* Reference to the style element created to hide options. Deleted when
					* the show options button is clicked
					*/
					_hideOptionsStyleElement: {
						type: HTMLElement,
					},
					/**
					* List of selected options (e.g., ['optionA', ...]s)
					*/
					_optionsSelected: {
						type: Array,
						value: function() { return []; },
					},
					/**
					* Visibility of 'More' button, true if hideAfter is present
					*/
					_showOptionsButtonVisible: {
						type: Boolean,
						value: false,
					},
					/**
					* Number of facet options initially displayed. All options are shown by default.
					* Should not be greater than the number of child elements
					*/
					hideAfter: {
						type: Number,
					},
					/**
					* The name of the grouping
					*/
					text: {
						type: String,
						value: '',
					},
					/**
					* The value of the grouping name
					*/
					value: {
						type: String,
						value: '',
					},
				};
			}

			connectedCallback() {
				super.connectedCallback();

				if (this.hideAfter) {
					this._hideOptions();
					this._showOptionsButtonVisible = true;
				}

				Polymer.RenderStatus.afterNextRender(this, function() {
					this._boundListeners._onFacetOptionChange = this._onFacetOptionChange.bind(this);

					this.addEventListener('d2l-search-facets-option-change',
						this._boundListeners._onFacetOptionChange);

				}.bind(this));
			}

			disconnectedCallback() {
				super.disconnectedCallback();
				this.removeEventListener('d2l-search-facets-option-change',
					this._boundListeners._onFacetOptionChange);
			}

			_onFacetOptionChange(e) {
				this.dispatchEvent(new CustomEvent('d2l-search-facets-grouping-change', {
					bubbles: true,
					composed: true,
					detail: Object.assign({}, e.detail, { grouping: this.value })
				}));
			}

			_hideOptions() {
				const styleElement = document.createElement('style');
				styleElement.type = 'text/css';
				const hideOptionsCss = `.d2l-search-facets-grouping-fieldset ::slotted(d2l-search-facets-option:nth-child(n+${this.hideAfter + 1})) {
					display: none
				}`;
				styleElement.appendChild(document.createTextNode(hideOptionsCss));
				this._hideOptionsStyleElement = styleElement;

				this.shadowRoot.appendChild(styleElement);
			}

			_showOptions() {
				this.shadowRoot.removeChild(this._hideOptionsStyleElement);
				this._showOptionsButtonVisible = false;
			}
		}

		customElements.define(SearchFacetsGrouping.is, SearchFacetsGrouping);
	</script>
</dom-module>
