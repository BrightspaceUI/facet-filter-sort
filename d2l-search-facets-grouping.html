<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../d2l-inputs/d2l-input-checkbox-spacer.html">
<link rel="import" href="../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">

<dom-module id="d2l-search-facets-grouping">
	<template strip-whitespace>
		<style>
			:host {
				display: block;
			}

			.d2l-search-facets-grouping-fieldset {
				border: none;
				margin: 0;
				padding: 0;
			}

			.d2l-search-facets-grouping-legend {
				@apply --d2l-body-compact-text;
				font-weight: bold;
				margin-bottom: 0.4rem;
				padding: 0;
			}

			.d2l-search-facets-grouping-show-more > button {
				@apply --d2l-body-compact-text;
				border: none;
				color: var(--d2l-color-celestine);
				font-family: inherit;
				outline: none;
				padding: 0;
			}

			.d2l-search-facets-grouping-show-more > button:hover,
			.d2l-search-facets-grouping-show-more > button:focus {
				cursor: pointer;
				font-weight: bold;
			}

		</style>
		<fieldset class="d2l-search-facets-grouping-fieldset">
			<legend class="d2l-search-facets-grouping-legend">[[text]]</legend>
			<slot></slot>
			<template is="dom-if" if="[[_showMoreButtonVisible]]">
				<d2l-input-checkbox-spacer class="d2l-search-facets-grouping-show-more">
					<button on-click="_showMore">More</button>
				</d2l-input-checkbox-spacer>
			</template>
		</fieldset>
	</template>
	<script>
		/**
		 * `<d2l-search-facets-grouping>`
		 * A grouping of search facet options that keeps tracks of selected options
		 */
		class SearchFacetsGrouping extends Polymer.Element {
			static get is() { return 'd2l-search-facets-grouping'; }
			static get properties() {
				return {
					/**
					* Reference to bound listener functions to be removed in disconnectedCallback
					*/
					_boundListeners: {
						type: Object,
						value: function() {
							return {
								_onFacetOptionChange: null,
							};
						}
					},
					/**
					* List of <d2l-search-facets-option> elements
					*/
					_optionElements: {
						type: Array,
						value: function() { return []; },
					},
					/**
					* List of selected options (e.g., ['optionA', ...]s)
					*/
					_optionsSelected: {
						type: Array,
						value: function() { return []; },
					},
					/**
					* Visibility of 'More' button - true if initiallyShown < _optionElements.length
					*/
					_showMoreButtonVisible: {
						type: Boolean,
						value: false,
					},
					/**
					* Number of facet options initially displayed. All options are shown by default
					*/
					hideAfter: {
						type: Number,
					},
					/**
					* The name of the grouping
					*/
					text: {
						type: String,
						value: '',
					},
					/**
					* The value of the grouping name
					*/
					value: {
						type: String,
						value: '',
					},
				};
			}

			connectedCallback() {
				super.connectedCallback();
				Polymer.RenderStatus.afterNextRender(this, function() {
					// Child elements may not be rendered if this is a <dom-repeat>. Wait for next
					// render to query for them
					this._boundListeners._onFacetOptionChange = this._onFacetOptionChange.bind(this);

					this.addEventListener('d2l-search-facets-option-change',
						this._boundListeners._onFacetOptionChange);

					if (!this.hideAfter) {
						this.hideAfter = this._getOptionElements().length;
					}

					this._showMoreButtonVisible = this.hideAfter < this._getOptionElements().length;
					this._updateOptionVisibility('none');
				}.bind(this));
			}

			disconnectedCallback() {
				super.disconnectedCallback();
				this.removeEventListener('d2l-search-facets-option-change',
					this._boundListeners._onFacetOptionChange);
			}

			_getOptionElements() {
				return Polymer.FlattenedNodesObserver.getFlattenedNodes(this)
					.filter(function(n) { return n.nodeType === Node.ELEMENT_NODE; });
			}

			_onFacetOptionChange(e) {
				e.detail.checked
					? this._optionsSelected.push(e.detail.value)
					: this._optionsSelected.splice(this._optionsSelected.indexOf(e.detail.value), 1);

				this.dispatchEvent(new CustomEvent(
					'd2l-search-facets-grouping-change', {
						bubbles: true, composed: true, detail:
						{
							grouping: this.value,
							selected: this._optionsSelected,
						}
					}
				));
			}

			_showMore() {
				this._updateOptionVisibility('block');
				this._showMoreButtonVisible = false;
			}

			_updateOptionVisibility(display) {
				const optionElements = this._getOptionElements();
				for (let index = this.hideAfter; index < optionElements.length; index++) {
					optionElements[index].style.display = display;
				}
			}

		}
		customElements.define(SearchFacetsGrouping.is, SearchFacetsGrouping);
	</script>
</dom-module>
